+++ Configuring Data Protection Modes +++


Oracle Data Guard provides three protection modes:
=> maximum performance
=> maximum availability
=> maximum protection


ALTER DATABASE  SET STANDBY DATABASE TO MAXIMIZE AVAILABILITY {AVAILABILITY | PERFORMANCE | PROTECTION};

As LGWR & ARCH parameters are deprecated now ,New parameters for LOG_ARCHIVE_DEST_n as below.

SYNC with AFFIRM and SYNC with NOAFFIRM

It is important to understand the possible results of using the LOG_ARCHIVE_DEST_n attributes SYNC/AFFIRM versus SYNC/NOAFFIRM (FastSync).

When a transport is performed using SYNC/AFFIRM, the primary performs write operations and waits for acknowledgment that the 
redo has been transmitted synchronously to the physical standby and written to disk. 

When a transport is performed using SYNC/NOAFFIRM, the primary performs write operations and waits only for acknowledgement 
that the data has been received on the standby, not that it has been written to disk. 

In the case of SYNC/AFFIRM, in which there is a check to confirm that data is written to disk on the standby, 
there would be no data loss because the data would be available on the standby when the system was recovered.
In the case of SYNC/NOAFFIRM, in which there is no check that data has been written to disk on the standby, there may be some data loss.


+++ Protection Modes

Maximum Performance 

This protection mode provides the highest level of data protection that is possible without affecting the performance of a primary database. 
This is accomplished by allowing transactions to commit as soon as all redo data generated by those transactions has been written to the online log. 
Redo data is also written to one or more standby databases, but this is done asynchronously with respect to transaction commitment, 
so primary database performance is unaffected by the time required to transmit redo data and receive acknowledgment from a standby database. 
This protection mode offers slightly less data protection than maximum availability mode and has minimal impact on primary database performance. 
This is the default protection mode.



Maximum Availability

This protection mode provides the highest level of data protection that is possible without compromising the availability of a primary database. 
Under normal operations, transactions do not commit until all redo data needed to recover 
those transactions has been written to the online redo log AND based on user configuration, one of the following is true:

=> redo has been received at the standby, I/O to the standby redo log has been initiated, and acknowledgement sent back to primary(SYNC/NOAFFIRM)
=> redo has been received and written to standby redo log at the standby and acknowledgement sent back to primary(SYNC/AFFIRM)

If the primary does not receive acknowledgement from at least one synchronized standby, 
then it operates as if it were in maximum performance mode to preserve primary database availability until it is again able to write its redo stream to a synchronized standby database


Maximum Protection

Maximum protection is similar to maximum availability but provides an additional level of data protection in the event of multiple failure events. 
Unlike maximum availability, which allows the primary to continue processing if it is unable to receive acknowledgement from a standby database, 
maximum protection shuts the primary database down rather than allowing it to continue processing transactions that are unprotected.


++++ Change ++++


Maximum Performance --> Maximum Availability

Atleast one LOG_ARCHIVE_DEST_n parameter ,which corresponds to standbydatabase ,must use SYNC/AFFIRM or SYNC/NOAFFIRM.


ON PRIMARY: 

DGMGRL> disable configuration;
Disabled.
DGMGRL>
DGMGRL>
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxPerformance
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
DISABLED

SQL> show parameter log_archive_
log_archive_dest_2                   string      service="DGHOL_pd9_lhr", ASYNC
                                                  NOAFFIRM delay=0 optional com
                                                 pression=disable max_failure=0
                                                  reopen=300 db_unique_name="DG
                                                 HOL_pd9_lhr" net_timeout=30, v
                                                 alid_for=(online_logfile,all_r
                                                 oles)


alter system set log_archive_dest_2 = 'service=DGHOL_pd9_lhr SYNC  NOAFFIRM db_unique_name=DGHOL_pd9_lhr valid_for=(online_logfile,all_roles)';

SQL> conn /as sysdba
Connected.
SQL>
SQL> alter system set log_archive_dest_2 = 'service=DGHOL_pd9_lhr SYNC  NOAFFIRM db_unique_name=DGHOL_pd9_lhr valid_for=(online_logfile,all_roles)';

System altered.


SQL> SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ WRITE           PRIMARY          MAXIMUM PERFORMANCE


SQL> show parameter log_archive_dest_2

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
log_archive_dest_2                   string      service=DGHOL_pd9_lhr SYNC  NO
                                                 AFFIRM db_unique_name=DGHOL_pd
                                                 9_lhr valid_for=(online_logfil
                                                 e,all_roles)
SQL> show parameter log_archive_dest_state_2

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
log_archive_dest_state_2             string      ENABLE



ON STANDBY:
SQL> SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ ONLY WITH APPLY PHYSICAL STANDBY MAXIMUM PERFORMANCE

SQL> select process,status,sequence# from v$managed_standby;

PROCESS   STATUS        SEQUENCE#
--------- ------------ ----------
DGRD      ALLOCATED             0
ARCH      CLOSING               7
DGRD      ALLOCATED             0
ARCH      CONNECTED             0
ARCH      CONNECTED             0
ARCH      CONNECTED             0
ARCH      CONNECTED             0
ARCH      CONNECTED             0
ARCH      CONNECTED             0
ARCH      CONNECTED             0
RFS       IDLE                  0

PROCESS   STATUS        SEQUENCE#
--------- ------------ ----------
RFS       RECEIVING             8
MRP0      APPLYING_LOG          8

13 rows selected.

PERFORMANCE 

ON PRIMARY:

SQL> conn /as sysdba
Connected.
SQL> ALTER DATABASE SET STANDBY DATABASE TO MAXIMIZE AVAILABILITY;

Database altered.


SQL> SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ WRITE           PRIMARY          MAXIMUM AVAILABILITY



ON STANDBY:
SQL> SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ ONLY WITH APPLY PHYSICAL STANDBY MAXIMUM AVAILABILITY



Maximum Availability --> Maximum Protection

SQL> SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ WRITE           PRIMARY          MAXIMUM AVAILABILITY


ON PRIMARY: 

alter system set log_archive_dest_2 = 'service=DGHOL_pd9_lhr SYNC  AFFIRM db_unique_name=DGHOL_pd9_lhr valid_for=(online_logfile,all_roles)';


12:29:53 SQL> alter system set log_archive_dest_2 = 'service=DGHOL_pd9_lhr SYNC  AFFIRM db_unique_name=DGHOL_pd9_lhr valid_for=(online_logfile,all_roles)';

System altered.


12:33:07 SQL> ALTER DATABASE  SET STANDBY DATABASE TO MAXIMIZE PROTECTION ;

Database altered.


12:33:41 SQL> SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ WRITE           PRIMARY          MAXIMUM PROTECTION

Elapsed: 00:00:00.00

ON STANDBY :
SQL> SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ ONLY WITH APPLY PHYSICAL STANDBY MAXIMUM PROTECTION



12:54:55 SQL>  ALTER DATABASE  SET STANDBY DATABASE TO MAXIMIZE PERFORMANCE;

Database altered.

Elapsed: 00:00:00.02
12:55:05 SQL> ALTER DATABASE  SET STANDBY DATABASE TO MAXIMIZE AVAILABILITY;

Database altered.

Elapsed: 00:00:00.01
12:55:11 SQL>  ALTER DATABASE  SET STANDBY DATABASE TO MAXIMIZE PROTECTION;

Database altered.




+++++++++++++++ Broker +++++++++++++++++++++


[oracle@adgholad1-89531 ~]$ dgmgrl
DGMGRL for Linux: Release 19.0.0.0.0 - Production on Fri Jun 21 12:58:33 2024
Version 19.23.0.0.0

Copyright (c) 1982, 2019, Oracle and/or its affiliates.  All rights reserved.

Welcome to DGMGRL, type "help" for information.
DGMGRL> connect /
Connected to "DGHOL_qz4_lhr"
Connected as SYSDBA.
DGMGRL>
DGMGRL>
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxPerformance
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
DISABLED

DGMGRL> enable configuration
Enabled.
DGMGRL>
DGMGRL>
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxPerformance
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 15438 seconds ago)

DGMGRL>


DGMGRL> show database DGHOL_qz4_lhr 'LogXptMode';
  LogXptMode = 'ASYNC'
  
  
SQL> show parameter log_archive

NAME                                 TYPE        VALUE
------------------------------------ ----------- ------------------------------
log_archive_config                   string      dg_config=(DGHOL_qz4_lhr,DGHOL
                                                 _pd9_lhr)
log_archive_dest_2                   string      service="DGHOL_pd9_lhr", ASYNC
                                                  NOAFFIRM delay=0 optional com
                                                 pression=disable max_failure=0
                                                  reopen=300 db_unique_name="DG
                                                 HOL_pd9_lhr" net_timeout=30, v
                                                 alid_for=(online_logfile,all_r
                                                 oles)

DGMGRL>edit database DGHOL_qz4_lhr set property LogXptMode = SYNC;

DGMGRL>edit database DGHOL_pd9_lhr set property LogXptMode = SYNC;

DGMGRL>  edit configuration set protection mode as maxavailability;

Succeeded.
DGMGRL>
DGMGRL>
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxAvailability
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 5 seconds ago)




===> MaxPerformance

DGMGRL>edit database DGHOL_qz4_lhr set property LogXptMode = ASYNC;

DGMGRL>edit database DGHOL_pd9_lhr set property LogXptMode = ASYNC;

DGMGRL> edit configuration set protection mode as maxperformance;
Succeeded.
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxPerformance
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 14 seconds ago)



====> MaxAvailability

DGMGRL>edit database DGHOL_qz4_lhr set property LogXptMode = FASTSYNC; | SYNC

DGMGRL>edit database DGHOL_pd9_lhr set property LogXptMode = FASTSYNC; | SYNC 


DGMGRL>  edit configuration set protection mode as maxavailability;
Succeeded.
DGMGRL>
DGMGRL>
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxAvailability
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 5 seconds ago)


===> MaxProtection

DGMGRL>edit database DGHOL_qz4_lhr set property LogXptMode = SYNC;

DGMGRL>edit database DGHOL_pd9_lhr set property LogXptMode = SYNC;

DGMGRL> edit configuration set protection mode as maxprotection;


DGMGRL> edit configuration set protection mode as maxprotection;
Succeeded.
DGMGRL>
DGMGRL>
DGMGRL>
DGMGRL>
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxProtection
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 19 seconds ago)




+++ Testing MaxProtection +++

ON PRIMARY:

SQL> create table test_promax (id number);

Table created.

SQL> insert into test_promax values(100);

1 row created.

SQL> commit;

Commit complete.


ON STANDBY:

SQL> select * from test_promax;

no rows selected

SQL>
SQL> /

        ID
----------
       100


SQL> host ps -ef | grep pmon
oracle   33385     1  0 01:18 ?        00:00:02 ora_pmon_DGHOL


host kill -9 33385

ON PRIMARY:

SQL> select * from test_promax;

        ID
----------
       100

SQL> insert into test_promax values(200);

1 row created.

SQL> commit;
commit
     *
ERROR at line 1:
ORA-03113: end-of-file on communication channel
Process ID: 87772
Session ID: 329 Serial number: 7285



2024-06-21T13:25:29.336426+00:00
NSS2 (PID:93296): Error 12514 received logging on to the standby
2024-06-21T13:25:29.336749+00:00
LGWR (PID:13953): Error 12514 attaching to RFS for reconnect
2024-06-21T13:25:34.342785+00:00



NSS2 (PID:93296): Error 12514 received logging on to the standby
2024-06-21T13:30:20.265522+00:00
LGWR (PID:13953): Error 12514 attaching to RFS for reconnect
2024-06-21T13:30:20.337769+00:00
Errors in file /u01/app/oracle/diag/rdbms/dghol_qz4_lhr/DGHOL/trace/DGHOL_lgwr_13953.trc:
ORA-03113: end-of-file on communication channel
LGWR (PID:13953): Error 3113 for LNO:3 to 'DGHOL_pd9_lhr'
2024-06-21T13:30:20.340724+00:00
LGWR (PID:13953): LAD:2 is UNSYNCHRONIZED
LGWR (PID:13953): All standby destinations have failed
LGWR (PID:13953): *************************************************************************
LGWR (PID:13953): WARN: All standby database destinations have failed
LGWR (PID:13953): WARN: Instance shutdown required to protect primary
LGWR (PID:13953): *************************************************************************
LGWR (ospid: 13953): terminating the instance due to ORA error 16098
2024-06-21T13:30:20.411333+00:00
System state dump requested by (instance=1, osid=13953 (LGWR)), summary=[abnormal instance termination].
System State dumped to trace file /u01/app/oracle/diag/rdbms/dghol_qz4_lhr/DGHOL/trace/DGHOL_diag_13930.trc
2024-06-21T13:30:21.571116+00:00
Dumping diagnostic data in directory=[cdmp_20240621133020], requested by (instance=1, osid=13953 (LGWR)), summary=[abnormal instance termination].
2024-06-21T13:30:22.308886+00:00
ORA-1092 : opitsk aborting process
2024-06-21T13:30:22.858982+00:00
Instance terminated by LGWR, pid = 13953
2024-06-21T13:30:22.860377+00:00
Warning: 2 processes are still attacheded to shmid 19:
 (size: 2097152 bytes, creator pid: 13896, last attach/detach pid: 2076)



SQL> conn /as sysdba
Connected to an idle instance.
SQL> startup
ORACLE instance started.

Total System Global Area 1.4496E+10 bytes
Fixed Size                  9194760 bytes
Variable Size            1912602624 bytes
Database Buffers         1.2415E+10 bytes
Redo Buffers              158576640 bytes
Database mounted.
ORA-03113: end-of-file on communication channel
Process ID: 2824
Session ID: 166 Serial number: 16579


ON STANDBY:

SQL> conn /as sysdba
Connected to an idle instance.
SQL> startup
ORACLE instance started.

Total System Global Area 1.4496E+10 bytes
Fixed Size                  9194760 bytes
Variable Size            1845493760 bytes
Database Buffers         1.2482E+10 bytes
Redo Buffers              158576640 bytes
Database mounted.
Database opened.



ON PRIMARY:

SQL> startup
ORACLE instance started.

Total System Global Area 1.4496E+10 bytes
Fixed Size                  9194760 bytes
Variable Size            1912602624 bytes
Database Buffers         1.2415E+10 bytes
Redo Buffers              158576640 bytes
Database mounted.
Database opened.



++++++++++

DGMGRL> edit configuration set protection mode as maxavailability;
Succeeded.
DGMGRL> show configuration

Configuration - DGHOL_qz4_lhr_DGHOL_pd9_lhr

  Protection Mode: MaxAvailability
  Members:
  DGHOL_qz4_lhr - Primary database
    DGHOL_pd9_lhr - Physical standby database

Fast-Start Failover:  Disabled

Configuration Status:
SUCCESS   (status updated 33 seconds ago)



SQL> select * from test_promax;

        ID
----------
       100

SQL> insert into test_promax values(200);

1 row created.

SQL> commit;

Commit complete.

ON STANDBY:

SQL> select * from test_promax;

        ID
----------
       100
       200

SQL> host ps -ef | grep pmon
oracle   95614     1  0 13:32 ?        00:00:00 ora_pmon_DGHOL
oracle   97461 80221  0 13:35 pts/0    00:00:00 /bin/bash -c ps -ef | grep pmon
oracle   97463 97461  0 13:35 pts/0    00:00:00 grep pmon

SQL> host kill -9 95614

SQL> conn /as sysdba
ERROR:
ORA-03113: end-of-file on communication channel
Process ID: 0
Session ID: 169 Serial number: 41591


ON PRIMARY:

SQL> insert into test_promax values(300);

1 row created.

SQL> commit;

Commit complete.

SQL>  SELECT NAME,OPEN_MODE,DATABASE_ROLE,PROTECTION_MODE FROM GV$DATABASE;

NAME      OPEN_MODE            DATABASE_ROLE    PROTECTION_MODE
--------- -------------------- ---------------- --------------------
DGHOL     READ WRITE           PRIMARY          MAXIMUM AVAILABILITY



